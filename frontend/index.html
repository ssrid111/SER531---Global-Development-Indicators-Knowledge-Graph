<!DOCTYPE html>
<html>
<head>
    <title>Global Development Indicators KG</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f7f9fc;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: #1E4F8C;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
        }
        .status-bar {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-online {
            background: #4CAF50;
        }
        .status-offline {
            background: #f44336;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel h2 {
            margin-top: 0;
            color: #1E4F8C;
        }
        textarea { 
            width: 100%; 
            height: 200px; 
            padding: 10px;
            border: 1px solid #ccc;
            font-size: 14px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            box-sizing: border-box;
        }
        button {
            padding: 12px 25px;
            background: #1E4F8C;
            color: white;
            border: none;
            border-radius: 6px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #153d6b;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #5a6268;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            white-space: pre-wrap;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }
        .results-table th {
            background: #1E4F8C;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .results-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #dee2e6;
        }
        .results-table tr:hover {
            background: #f8f9fa;
        }
        .results-table tr:last-child td {
            border-bottom: none;
        }
        .results-info {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .json-toggle {
            margin-top: 10px;
            padding: 8px 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .json-toggle:hover {
            background: #5a6268;
        }
        .info-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #856404;
        }
        .query-examples {
            margin-top: 15px;
        }
        .example-query {
            background: #f8f9fa;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #1E4F8C;
            cursor: pointer;
            border-radius: 4px;
        }
        .example-query:hover {
            background: #e9ecef;
        }
        .example-query code {
            font-size: 12px;
        }
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>üåç Global Development Indicators Knowledge Graph</h1>
    <p>SPARQL Query Console & Data Management</p>
</div>

<div class="status-bar">
    <div class="status-item">
        <span class="status-indicator" id="fusekiStatus"></span>
        <span>Fuseki Server: <strong id="fusekiStatusText">Checking...</strong></span>
    </div>
    <div class="status-item">
        <span class="status-indicator" id="backendStatus"></span>
        <span>Backend API: <strong id="backendStatusText">Checking...</strong></span>
    </div>
    <div class="status-item">
        <a href="http://localhost:3030" target="_blank" style="color: #1E4F8C; text-decoration: none;">üîó Open Fuseki Admin</a>
    </div>
</div>

<div class="container">
    <div class="panel">
        <h2>üìä SPARQL Query</h2>
        
        <div class="info-box">
            <h3>‚ÑπÔ∏è Quick Setup</h3>
            <p><strong>If you see errors:</strong></p>
            <ol>
                <li>Go to <a href="http://localhost:3030" target="_blank">Fuseki Admin</a></li>
                <li>Create dataset named: <code>dataset</code></li>
                <li>Upload your RDF file: <code>rdf/output.ttl</code></li>
                <li>Refresh this page and try again</li>
            </ol>
        </div>

        <textarea id="queryBox">
PREFIX kg: <http://www.semanticweb.org/ser531/KnowledgeGraph/>

SELECT DISTINCT ?obs ?country ?indicator ?sdg ?location ?value
WHERE {
  ?obs a kg:Observation ;
       kg:hasCountry ?country ;
       kg:hasIndicator ?indicator ;
       kg:hasSDG ?sdg ;
       kg:locatedIn ?location ;
       kg:hasValue ?value .
} limit 50
</textarea>

        <br>
        <button onclick="runQuery()">‚ñ∂Ô∏è Run Query</button>
        <button class="secondary" onclick="checkStatus()">üîÑ Check Status</button>

        <div class="query-examples">
            <h3>Example Queries (Click to use)</h3>
            <div class="example-query" onclick="setQuery('PREFIX kg: <http://www.semanticweb.org/ser531/KnowledgeGraph/>\n\nSELECT ?country (COUNT(DISTINCT ?sdg) AS ?sdgCount) WHERE{\n  ?obs a kg:Observation ;\n            kg:hasCountry ?country ;\n            kg:hasSDG ?sdg .\n}\nGROUP BY ?country\nORDER BY DESC(?sdgCount)')">
                <strong>1. Countries contributing to the most SDGs</strong><br>
                <code>SELECT ?indicator ?name ?sdgNumber WHERE { ?indicator a sdg:Indicator ; sdg:indicatorName ?name ; sdg:sdgNumber ?sdgNumber . }</code>
            </div>
            <div class="example-query" onclick="setQuery('PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\nPREFIX kg: <http://example.org/kg/>\nPREFIX sdg: <http://example.org/sdg/>\n\nSELECT ?indicator ?name WHERE {\n  ?indicator a sdg:Indicator ;\n            sdg:indicatorName ?name ;\n            sdg:sdgNumber 1 .\n}')">
                <strong>2. SDG 1 indicators (No Poverty)</strong><br>
                <code>SELECT ?indicator ?name WHERE { ?indicator a sdg:Indicator ; sdg:sdgNumber 1 . }</code>
            </div>
            <div class="example-query" onclick="setQuery('PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\nPREFIX kg: <http://example.org/kg/>\nPREFIX sdg: <http://example.org/sdg/>\n\nSELECT ?indicator ?name ?source WHERE {\n  ?indicator a sdg:Indicator ;\n            sdg:indicatorName ?name ;\n            sdg:source ?source ;\n            sdg:hasGlobalCoverage true .\n}\nLIMIT 20')">
                <strong>3. Indicators with global coverage</strong><br>
                <code>SELECT ?indicator ?name ?source WHERE { ?indicator a sdg:Indicator ; sdg:hasGlobalCoverage true . }</code>
            </div>
            <div class="example-query" onclick="setQuery('PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\nPREFIX kg: <http://example.org/kg/>\nPREFIX sdg: <http://example.org/sdg/>\n\nSELECT ?sdgNumber (COUNT(?indicator) AS ?indicatorCount) WHERE {\n  ?indicator a sdg:Indicator ;\n            sdg:sdgNumber ?sdgNumber .\n}\nGROUP BY ?sdgNumber\nORDER BY ?sdgNumber')">
                <strong>4. Count indicators by SDG</strong><br>
                <code>SELECT ?sdgNumber (COUNT(?indicator) AS ?count) WHERE { ?indicator a sdg:Indicator ; sdg:sdgNumber ?sdgNumber . } GROUP BY ?sdgNumber</code>
            </div>
            <div class="example-query" onclick="setQuery('PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\nPREFIX kg: <http://example.org/kg/>\nPREFIX sdg: <http://example.org/sdg/>\n\nSELECT (COUNT(?indicator) AS ?totalIndicators) WHERE {\n  ?indicator a sdg:Indicator .\n}')">
                <strong>5. Count total indicators</strong><br>
                <code>SELECT (COUNT(?indicator) AS ?total) WHERE { ?indicator a sdg:Indicator . }</code>
            </div>
            <div class="example-query" onclick="setQuery('PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\nPREFIX kg: <http://example.org/kg/>\nPREFIX sdg: <http://example.org/sdg/>\n\nSELECT ?indicator ?name ?sdgNumber WHERE {\n  ?indicator a sdg:Indicator ;\n            sdg:indicatorName ?name ;\n            sdg:sdgNumber ?sdgNumber .\n  FILTER (CONTAINS(LCASE(?name), \"poverty\"))\n}\nORDER BY ?sdgNumber')">
                <strong>6. Search: Poverty indicators</strong><br>
                <code>FILTER (CONTAINS(LCASE(?name), \"poverty\"))</code>
            </div>
            <div class="example-query" onclick="setQuery('PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\nPREFIX kg: <http://example.org/kg/>\nPREFIX sdg: <http://example.org/sdg/>\n\nSELECT ?indicator ?name ?optimum ?greenThreshold ?redThreshold WHERE {\n  ?indicator a sdg:Indicator ;\n            sdg:indicatorName ?name ;\n            sdg:optimum ?optimum ;\n            sdg:greenThreshold ?greenThreshold ;\n            sdg:redThreshold ?redThreshold .\n}\nLIMIT 10')">
                <strong>7. Get indicators with thresholds</strong><br>
                <code>SELECT ?name ?optimum ?greenThreshold ?redThreshold WHERE { ... }</code>
            </div>
            <div class="example-query" onclick="setQuery('PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\nPREFIX kg: <http://example.org/kg/>\nPREFIX sdg: <http://example.org/sdg/>\n\nSELECT ?source (COUNT(?indicator) AS ?indicatorCount) WHERE {\n  ?indicator a sdg:Indicator ;\n            sdg:source ?source .\n}\nGROUP BY ?source\nORDER BY DESC(?indicatorCount)')">
                <strong>8. Indicators by source organization</strong><br>
                <code>SELECT ?source (COUNT(?indicator) AS ?count) GROUP BY ?source</code>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>üìã Query Results</h2>
        <div id="resultsContainer">
            <div id="resultsInfo"></div>
            <div id="resultsTable"></div>
            <pre id="output" style="display: none;"></pre>
            <button class="json-toggle" id="toggleJson" style="display: none;" onclick="toggleJsonView()">Show Raw JSON</button>
        </div>
    </div>
</div>

<script>
// Check status on page load
window.addEventListener('load', () => {
    checkStatus();
});

async function checkStatus() {
    // Check Fuseki
    try {
        const fusekiRes = await fetch('http://localhost:3030', { method: 'HEAD', mode: 'no-cors' });
        document.getElementById('fusekiStatus').className = 'status-indicator status-online';
        document.getElementById('fusekiStatusText').textContent = 'Online';
    } catch (e) {
        document.getElementById('fusekiStatus').className = 'status-indicator status-offline';
        document.getElementById('fusekiStatusText').textContent = 'Offline - Start Fuseki!';
    }

    // Check Backend
    try {
        const backendRes = await fetch('http://localhost:5000', { method: 'HEAD' });
        document.getElementById('backendStatus').className = 'status-indicator status-online';
        document.getElementById('backendStatusText').textContent = 'Online';
    } catch (e) {
        document.getElementById('backendStatus').className = 'status-indicator status-offline';
        document.getElementById('backendStatusText').textContent = 'Offline - Start Backend!';
    }
}

let showJsonView = false;

function toggleJsonView() {
    showJsonView = !showJsonView;
    const output = document.getElementById("output");
    const tableDiv = document.getElementById("resultsTable");
    const toggleBtn = document.getElementById("toggleJson");
    
    if (showJsonView) {
        output.style.display = "block";
        tableDiv.style.display = "none";
        toggleBtn.textContent = "Show Table View";
    } else {
        output.style.display = "none";
        tableDiv.style.display = "block";
        toggleBtn.textContent = "Show Raw JSON";
    }
}

function displayResults(jsonData) {
    const resultsInfo = document.getElementById("resultsInfo");
    const resultsTable = document.getElementById("resultsTable");
    const output = document.getElementById("output");
    const toggleBtn = document.getElementById("toggleJson");
    
    // Store JSON for toggle
    output.textContent = JSON.stringify(jsonData, null, 2);
    
    // Check if it's SPARQL results format
    if (jsonData.head && jsonData.results) {
        const vars = jsonData.head.vars;
        const bindings = jsonData.results.bindings;
        
        // Show info
        resultsInfo.innerHTML = `<strong>Found ${bindings.length} result(s)</strong>`;
        
        // Create table
        if (bindings.length > 0) {
            let tableHTML = '<table class="results-table"><thead><tr>';
            
            // Header row
            vars.forEach(v => {
                tableHTML += `<th>${v}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            // Data rows
            bindings.forEach(binding => {
                tableHTML += '<tr>';
                vars.forEach(v => {
                    const value = binding[v];
                    if (value) {
                        let displayValue = value.value;
                        // Clean up URIs - show only the last part
                        if (value.type === 'uri') {
                            const parts = displayValue.split('/');
                            displayValue = parts[parts.length - 1].replace(/_/g, ' ');
                        }
                        // Truncate long values
                        if (displayValue.length > 50) {
                            displayValue = displayValue.substring(0, 50) + '...';
                        }
                        tableHTML += `<td title="${value.value}">${displayValue}</td>`;
                    } else {
                        tableHTML += '<td>-</td>';
                    }
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            resultsTable.innerHTML = tableHTML;
        } else {
            resultsTable.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">No results found.</p>';
        }
        
        toggleBtn.style.display = "inline-block";
    } else {
        // Not SPARQL format, show as JSON
        resultsInfo.innerHTML = '';
        resultsTable.innerHTML = '';
        output.style.display = "block";
        toggleBtn.style.display = "none";
    }
}

async function runQuery() {
    const query = document.getElementById("queryBox").value;
    const resultsInfo = document.getElementById("resultsInfo");
    const resultsTable = document.getElementById("resultsTable");
    
    resultsInfo.innerHTML = "‚è≥ Executing query...";
    resultsTable.innerHTML = "";
    
    try {
        const res = await fetch("http://localhost:5000/api/runQuery", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "query=" + encodeURIComponent(query)
        });

        const text = await res.text();
        
        // Try to parse JSON
        try {
            const jsonData = JSON.parse(text);
            displayResults(jsonData);
        } catch {
            resultsInfo.innerHTML = '';
            resultsTable.innerHTML = `<pre style="background: #f8f9fa; padding: 15px; border-radius: 6px;">${text}</pre>`;
        }
    } catch (error) {
        resultsInfo.innerHTML = '';
        resultsTable.innerHTML = `<div style="background: #fee; padding: 15px; border-radius: 6px; color: #c33;">
            <strong>‚ùå Error:</strong> ${error.message}<br><br>
            <strong>Make sure:</strong><br>
            1. Fuseki is running at http://localhost:3030<br>
            2. Dataset 'dataset' exists in Fuseki<br>
            3. Data is uploaded to the dataset
        </div>`;
    }
}

function setQuery(queryText) {
    document.getElementById("queryBox").value = queryText;
}
</script>

</body>
</html>
